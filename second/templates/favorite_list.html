{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">내 즐겨찾기</h4>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'map_view' %}">지도 보기</a>
  </div>

  {% if favorites %}
    <div class="row g-3">
      {% for f in favorites %}
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">{{ f.parking.pkplcNm }}</div>
                <div class="text-muted small">
                  {{ f.parking.roadNmAddr|default:"주소 정보 없음" }}
                </div>
                <div class="text-muted small">
                  등록: {{ f.created_at|date:"Y-m-d H:i" }}
                </div>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-primary"
                   href="{% url 'map_view' %}?focus_id={{ f.parking.pkplcId|urlencode }}">
                  지도에서 보기
                </a>
                <button class="btn btn-sm btn-outline-danger js-unfav"
                        data-pk="{{ f.parking.pkplcId }}">
                  즐겨찾기 해제
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-light border text-center">
      아직 즐겨찾기한 주차장이 없습니다.
      <a href="{% url 'map_view' %}">지도로 이동</a>해서 ⭐을 눌러보세요.
    </div>
  {% endif %}
</div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const CSRF = getCookie('csrftoken');

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.js-unfav');
    if (!btn) return;

    const pk = btn.dataset.pk;
    if (!pk) return;

    if (!confirm('즐겨찾기를 해제할까요?')) return;

    try {
      const res = await fetch(`/favorites/${pk}/toggle/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        const card = btn.closest('.col-12');
        if (card) card.remove();
      } else {
        alert('처리 중 오류가 발생했습니다.');
      }
    } catch (err) {
      console.error(err);
      alert('네트워크 오류가 발생했습니다.');
    }
  });
</script>
{% endblock %}
