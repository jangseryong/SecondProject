{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">내 즐겨찾기</h4>
  </div>

  {% if favorites %}
    <div class="row g-3">
      {% for f in favorites %}
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">{{ f.parking.pkplcNm }}</div>
                <div class="text-muted small">
                  {{ f.parking.roadNmAddr|default:"주소 정보 없음" }}
                </div>
                <div class="text-muted small">
                  등록: {{ f.created_at|date:"Y-m-d H:i" }}
                </div>
              </div>
              <div class="d-flex gap-2">
                {# ✅ 주소창을 깔끔하게: 쿼리 없이 / 로 이동, focus_id는 sessionStorage로 전달 #}
                <a class="btn btn-sm btn-primary js-go-map"
                   href="{% url 'map_view' %}"
                   data-focus-id="{{ f.parking.pkplcId }}">
                  지도에서 보기
                </a>
                <button class="btn btn-sm btn-outline-danger js-unfav"
                        data-pk="{{ f.parking.pkplcId }}">
                  즐겨찾기 해제
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {% if is_paginated %}
    <nav class="mt-4" aria-label="즐겨찾기 페이지네이션">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page=1">&laquo;&laquo;</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">&raquo;&raquo;</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          <li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

  {% else %}
    <div class="alert alert-light border text-center">
      아직 즐겨찾기한 주차장이 없습니다.
      <a href="{% url 'map_view' %}">지도로 이동</a>해서 ⭐을 눌러보세요.
    </div>
  {% endif %}
</div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const CSRF = getCookie('csrftoken');

  // ✅ 지도에서 보기: 쿼리스트링 없이 / 로 이동 + sessionStorage로 focus 전달
  document.addEventListener('click', (e) => {
    const a = e.target.closest('.js-go-map');
    if (!a) return;
    e.preventDefault();
    const id = a.dataset.focusId;
    if (id) sessionStorage.setItem('focus_id', String(id));
    location.href = a.href; // 보통 "/"
  });

  // 즐겨찾기 해제
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.js-unfav');
    if (!btn) return;

    const pk = btn.dataset.pk;
    if (!pk) return;

    if (!confirm('즐겨찾기를 해제할까요?')) return;

    try {
      const res = await fetch(`/favorites/${pk}/toggle/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (res.ok && data.ok) {
        const card = btn.closest('.col-12');
        if (card) card.remove();
        // 전체가 비면 새로고침해서 빈상태/페이지네이션 반영
        if (document.querySelectorAll('.col-12').length === 0) {
          location.reload();
        }
      } else {
        alert('처리 중 오류가 발생했습니다.');
      }
    } catch (err) {
      console.error(err);
      alert('네트워크 오류가 발생했습니다.');
    }
  });
</script>
{% endblock %}
