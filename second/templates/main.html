{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
    }

    *, *::before, *::after {
        box-sizing: border-box;
    }

    .full-height {
        height: calc(100vh - 56px);
    }

    .sidebar {
        width: 350px;
        background-color: #f8f9fa;
        overflow-y: auto;
    }

    .map-area {
        flex-grow: 1;
        height: 100%;
        position: relative;
    }

    .list-group-item {
        margin: 0;
        padding-left: 12px;
        padding-right: 12px;
        border-left: none;
        border-right: none;
    }

    .sidebar {
        width: 350px;
        height: calc(100vh - 56px);
        display: flex;
        flex-direction: column;
    }

    .sidebar h5 {
        height: 4rem;
        line-height: 2rem;
        margin: 0;
        padding: 0 1rem;
        border-bottom: 1px solid #dee2e6;
        flex-shrink: 0;
    }

    .sidebar ul.list-group {
        flex-grow: 1;
        overflow-y: auto;
        margin: 0;
        padding: 0;
    }

    .location-button {
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 10;
        width: 40px;
        height: 40px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 5px;
        cursor: pointer;
        box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .location-button img {
        width: 22px;
        height: 22px;
    }

    .map-toggle-controls {
        position: absolute;
        top: 3px;
        right: 10px;
        z-index: 10;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        display: flex; /* Í∞ÄÎ°ú Î∞∞Ïπò */
        gap: 10px; /* Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
        align-items: center;
    }

    .map-toggle-controls button {
        background: white;
        border: none;
        cursor: pointer;
        padding: 3px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .map-toggle-controls button img {
        width: 30px;
        height: 30px;
    }


    .slider-left {
        animation-duration: 0.3s;
        animation-name: slide-in-from-left;
        animation-fill-mode: forwards;
    }

    @keyframes slide-in-from-left {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(-100%);
        }
    }

    .slider-right {
        animation-duration: 0.3s;
        animation-name: slide-in-from-right;
        animation-fill-mode: forwards;
    }

    @keyframes slide-in-from-right {
        from {
            transform: translateX(-100%);
        }
        to {
            transform: translateX(0);
        }
    }

    #sidebar {
        position: fixed;
        width: 350px;
        z-index: 3
    }

    #sidebar_toggle {
        background-color: white;
        position: absolute;
        top: 50%;
        right: -20px;
        width: 20px;
        height: 50px;
        padding: 0;
        margin: 0;
        border-bottom-right-radius: 5px;
        border-top-right-radius: 5px;
        border: 0;
    }

    .dropdown-menu {
        width: 100%;
    }

    input {
        border: 0;
    }

</style>

<div class="container-fluid p-0 m-0">
    <div class="d-flex full-height">

        <div id="sidebar">
            <!-- üÖøÔ∏è ÏôºÏ™Ω Ï£ºÏ∞®Ïû• Î™©Î°ù -->
            <div class="sidebar d-flex flex-column">
                <!-- Í≤ÄÏÉâÏ∞Ω + Í≤ÄÏÉâ Í≤∞Í≥º -->
                <div>
                    <div class="form-control focus-ring searchInput my-1 px-2" style="width: 98%; margin: 0 auto;">
                        <input type="text" class="dropdown-toggle" id="search-input"
                               placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" data-bs-toggle="dropdown" aria-expanded="false">

                        <button style="background-color: white; border: 0; display: flex; justify-content: center; align-content: center"
                                id="search-btn" type="button">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                 stroke="currentColor" style="width: 20px">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/>
                            </svg>
                        </button>
                    </div>

                    <ul id="autocomplete-results" class=" dropdown-menu"
                        style="max-height: 200px; overflow-y: auto;"></ul>
                </div>


                <ul id="parking-list" class="list-group list-group-flush flex-grow-1 overflow-auto">
                    {% for b in basics %}
                    <li class="list-group-item parking-item" data-name="{{ b.name }}" id="{{b.name}}" style="cursor: pointer">
                        <div class="fw-bold">{{ b.name }}</div>
                        Ï¥ù Íµ¨Ìöç: {{ b.total }}<br>
                        Í∞ÄÏö© ÎåÄÏàò: {{ b.avblPklotCnt }}<br>
                        Ï†úÍ≥µ ÏãúÍ∞Ñ: {{ b.ocrnDt }}<br>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <button id="sidebar_toggle" onclick="toggle_sidebar()">
                <
            </button>
        </div>

        <div class="map-area">
            <div id="map" style="width:100%; height:100%;"></div>
            <div class="map-toggle-controls">
                <button onclick="toggleParkingMarkers()" id="parkingToggleBtn" style="background-color:#ddd"><img
                        src="{% static 'imgs/parking-area.png' %}" alt="Ï£ºÏ∞®Ïû•" width="30"></button>

                <button onclick="toggleCCTVMarkers()" id="cctvToggleBtn" style="background-color:#ddd"><img
                        src="{% static 'imgs/security-camera.png' %}" alt="CCTV" width="30"></button>


            </div>
            <button class="location-button" onclick="moveToCurrentLocation()">
                <img src="{% static 'imgs/location_icon.png' %}" alt="ÎÇ¥ ÏúÑÏπò">
            </button>

        </div>
    </div>
</div>
<!-- üìå Kakao ÏßÄÎèÑ API -->
<script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

<!-- ÏÇ¨Ïù¥ÎìúÎ∞î Ïä¨ÎùºÏù¥Îî© -->
<script>

    let state = true;

    function toggle_sidebar() {
        if (state) {
            $("#sidebar_toggle").text(">");
            $("#sidebar").addClass("slider-left").removeClass("slider-right");
        } else {
            $("#sidebar_toggle").text("<");
            $("#sidebar").addClass("slider-right").removeClass("slider-left");
        }

        state = !state;
    }

</script>

<script>
    // ================== Î°úÍ∑∏Ïù∏ Ïó¨Î∂Ä ÌîåÎûòÍ∑∏ ==================
    const IS_AUTHENTICATED = {{request.user.is_authenticated | yesno:"true,false"}};

    // ================== Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†ÑÏó≠ Í¥ÄÎ¶¨ ==================
    let FAVORITE_SET = new Set();
    let CSRF_TOKEN = null;

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function loadFavorites() {
        if (!IS_AUTHENTICATED) {
            FAVORITE_SET = new Set();
            return;
        }
        try {
            const res = await fetch('/favorites/ids/', {credentials: 'same-origin'});
            if (!res.ok) return;
            const data = await res.json();
            if (data.ok) {
                FAVORITE_SET = new Set((data.ids || []).map(String));
                CSRF_TOKEN = data.csrfToken || getCookie('csrftoken');
            }
        } catch (e) {
            console.error(e);
        }
    }

    function setStarIcon(btnEl) {
        const pk = btnEl?.dataset?.pk;
        if (!pk) return;
        const icon = btnEl.querySelector('.star-icon');
        if (!icon) return;
        if (!IS_AUTHENTICATED) {
            icon.textContent = '‚òÜ';
            return;
        }
        icon.textContent = FAVORITE_SET.has(String(pk)) ? '‚≠ê' : '‚òÜ';
    }

    // ÌÅ¥Î¶≠ Ïãú Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.favorite-btn');
        if (!btn) return;

        if (!IS_AUTHENTICATED) {
            alert('Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        const pk = btn.dataset.pk;
        const icon = btn.querySelector('.star-icon');

        try {
            const res = await fetch(`/favorites/${pk}/toggle/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN || getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });

            if (res.status === 403) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            const data = await res.json();
            if (!data.ok) {
                alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                return;
            }

            if (data.status === 'added') {
                FAVORITE_SET.add(String(pk));
                if (icon) icon.textContent = '‚≠ê';
            } else {
                FAVORITE_SET.delete(String(pk));
                if (icon) icon.textContent = '‚òÜ';
            }
        } catch (err) {
            console.error(err);
            alert('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    });

    // ================== ÏßÄÎèÑ Î°úÏßÅ ==================
    const mapContainer = document.getElementById('map');
    const fixedLat = 37.6822186;
    const fixedLng = 126.769498;
    let currentMarker = null;
    let currentCircle = null;

    let locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
    const mapOption = {center: locPosition, level: 4};
    const map = new kakao.maps.Map(mapContainer, mapOption);

    map.setMaxLevel(4);
    map.setCopyrightPosition(kakao.maps.CopyrightPosition.BOTTOMRIGHT, true);

    const basics = JSON.parse('{{ basics_json|escapejs }}');
    const cameras = JSON.parse('{{ cctv_json|escapejs }}');
    const availability = JSON.parse('{{ availability_json|escapejs }}');

    const infowindow = new kakao.maps.InfoWindow({});
    const markerMap = {};
    const markerById = {};
    const basicsById = {};

    // ‚úÖ Ï£ºÏ∞®Ïû• / CCTV ÎßàÏª§ Î∞∞Ïó¥Í≥º ÏÉÅÌÉú Î≥ÄÏàò
    let parkingMarkers = [];
    let cctvMarkers = [];
    let parkingVisible = true;
    let cctvVisible = true;

    const parkingMarkerImage = new kakao.maps.MarkerImage(
        "{% static 'imgs/parking-area.png' %}",
        new kakao.maps.Size(35, 35),
        {offset: new kakao.maps.Point(20, 40)}
    );

    currentMarker = new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: 'ÎÇ¥ÏúÑÏπò'
    });

    currentCircle = new kakao.maps.Circle({
        center: locPosition,
        radius: 200,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        fillColor: '#FF0000',
        fillOpacity: 0.1,
        map: map
    });

    // ================== Ï£ºÏ∞®Ïû• ÎßàÏª§ Îì±Î°ù ==================
    basics.forEach(b => {
        const idStr = String(b.id);
        basicsById[idStr] = b;
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(b.lat, b.lng),
            title: b.name,
            map: map,
            image: parkingMarkerImage
        });
        marker.isOpen = false;
        markerMap[b.name] = marker;
        markerById[idStr] = marker;

        parkingMarkers.push(marker);   // ‚úÖ Î∞∞Ïó¥Ïóê Ï†ÄÏû•

        kakao.maps.event.addListener(marker, 'click', () => {
            toggleInfowindow(marker, b.name);
        });
    });

    const cameraMarkerImage = new kakao.maps.MarkerImage(
        "{% static 'imgs/security-camera.png' %}",
        new kakao.maps.Size(30, 30)
    );

    // ================== CCTV ÎßàÏª§ Îì±Î°ù ==================
    cameras.forEach(c => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(c.lat, c.lng),
            title: c.name,
            map: map,
            image: cameraMarkerImage
        });

        marker.isOpen = false;
        cctvMarkers.push(marker);   // ‚úÖ Î∞∞Ïó¥Ïóê Ï†ÄÏû•

        kakao.maps.event.addListener(marker, 'click', () => {
            if (marker.isOpen) {
                infowindow.close();
                marker.isOpen = false;
            } else {
                infowindow.close();
                infowindow.setContent(`
                    <div class="card" style="width: 18rem; margin:0;">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                        </div>
                    </div>
                `);
                infowindow.open(map, marker);
                marker.isOpen = true;
            }
        });
    });

    // ================== ÌÜ†Í∏Ä Ìï®Ïàò ==================
    function toggleParkingMarkers() {
        parkingVisible = !parkingVisible;
        parkingMarkers.forEach(m => m.setMap(parkingVisible ? map : null));
        document.getElementById('parkingToggleBtn').style.backgroundColor = parkingVisible ? "#ddd" : "white";
    }

    function toggleCCTVMarkers() {
        cctvVisible = !cctvVisible;
        cctvMarkers.forEach(m => m.setMap(cctvVisible ? map : null));
        document.getElementById('cctvToggleBtn').style.backgroundColor = cctvVisible ? "#ddd" : "white";
    }

    // ================== Ïù∏Ìè¨ÏúàÎèÑÏö∞ ==================
    function toggleInfowindow(marker, name) {
        const b = basics.find(b => b.name === name);
        if (!b) return;
        //
        // if (marker.isOpen) {
        //     infowindow.close();
        //     marker.isOpen = false;
        // }
            infowindow.close();

            const starChar = IS_AUTHENTICATED
                ? (FAVORITE_SET.has(String(b.id)) ? '‚≠ê' : '‚òÜ')
                : '‚òÜ';



            infowindow.setContent(`
              <div class="card shadow-sm" style="width: 300px; font-size: 14px; overflow-x: hidden;">
                  <div class="card-header bg-primary text-white fw-bold">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>${b.name}</span>
                        <button class="btn btn-sm btn-light favorite-btn" data-pk="${b.id}" title="Ï¶êÍ≤®Ï∞æÍ∏∞" style="line-height:1">
                          <span class="star-icon">${starChar}</span>
                        </button>
                    </div>
                  </div>

                  <div class="card-body p-2">
                      <div class="row gx-0 text-center mb-2">
                          <div class="col-6 border-end">
                              <div class="fw-bold">Ï¥ù Î©¥Ïàò</div>
                              <div>${b.total}</div>
                          </div>
                          <div class="col-6 bg-success text-white">
                              <div class="fw-bold">Í∞ÄÏö© Î©¥Ïàò</div>
                              <div>${b.avblPklotCnt}</div>
                          </div>
                      </div>
                      <hr style="margin: 0">
                      <table class="table table-sm mb-0">
                          <tbody>
                              <tr>
                                  <th scope="row" style="width: 70px;">Ï£ºÏÜå</th>
                                  <td>${b.address || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</td>
                              </tr>
                              <tr>
                                  <th scope="row">Ïö¥ÏòÅÏãúÍ∞Ñ</th>
                                  <td>
                                      ÌèâÏùº: ${b.weekdayTime || '-'}<br>
                                      ÌÜ†ÏöîÏùº: ${b.saturdayTime || '-'}<br>
                                      Ìú¥Ïùº: ${b.holidayTime || '-'}
                                  </td>
                              </tr>
                              <tr>
                                  <th scope="row">Ï£ºÏ∞®ÏöîÍ∏à</th>
                                  <td>
                                      Í∏∞Î≥∏: ${b.basicRate || '-'}<br>
                                      Ï∂îÍ∞Ä: ${b.addRate || '-'}
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
              </div>
          `);

            infowindow.open(map, marker);
            marker.isOpen = true;

            kakao.maps.event.addListener(infowindow, 'domready', function () {
                const btn = document.querySelector('.favorite-btn[data-pk="' + b.id + '"]');
                if (btn) setStarIcon(btn);
            });

    }

    // ================== Î¶¨Ïä§Ìä∏ ÌÅ¥Î¶≠ Ìè¨Ïª§Ïä§ ==================
    document.querySelectorAll('.parking-item').forEach(item => {
        item.addEventListener('click', () => {
            $(".parking-item").css("background", "white");
            const name = item.getAttribute('data-name');
            const marker = markerMap[name];
            if (marker) {
                map.panTo(marker.getPosition());
                toggleInfowindow(marker, name);
                item.style.backgroundColor = "lightgray";
            }
        });
    });

    // ================== ÏúÑÏπò Ïù¥Îèô ==================
    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // ‚úÖ Ï£ºÏ∞®Ïû• Î¶¨Ïä§Ìä∏ Îã§Ïãú Î†åÎçîÎßÅ
    function renderParkingList(sortedBasics) {
        const listContainer = document.getElementById('parking-list');
        listContainer.innerHTML = ''; // Í∏∞Ï°¥ Î¶¨Ïä§Ìä∏ ÎπÑÏö∞Í∏∞

        sortedBasics.forEach(b => {
            const li = document.createElement('li');
            li.className = 'list-group-item parking-item';
            li.dataset.name = b.name;
            li.innerHTML = `
                <div class="fw-bold">${b.name}</div>
                Ï¥ù Íµ¨Ìöç: ${b.total}<br>
                Í∞ÄÏö© ÎåÄÏàò: ${b.avblPklotCnt}<br>
                Ï†úÍ≥µ ÏãúÍ∞Ñ: ${b.ocrnDt}<br>
            `;
            // ÌÅ¥Î¶≠ Ïãú ÎßàÏª§ Ïù¥Îèô
            li.addEventListener('click', () => {
                const marker = markerMap[b.name];
                if (marker) {
                    map.panTo(marker.getPosition());
                    toggleInfowindow(marker, b.name);
                }
            });
            listContainer.appendChild(li);
        });
    }

    function focusAndOpenById(id) {
        const key = String(id);
        const b = basicsById[key], m = markerById[key];
        if (!b || !m) return false;
        map.panTo(m.getPosition());
        toggleInfowindow(m, b.name);
        return true;
    }

    function focusAndOpenByName(name) {
        const m = markerMap[name];
        if (!m) return false;
        map.panTo(m.getPosition());
        toggleInfowindow(m, name);
        return true;
    }

    function initFocusFromUrl() {
        const params = new URLSearchParams(location.search);
        const focusId = params.get('focus_id');
        const focusName = params.get('focus');
        if (focusId) {
            if (!focusAndOpenById(focusId) && focusName) focusAndOpenByName(focusName);
        } else if (focusName) {
            focusAndOpenByName(focusName);
        }
    }

    // ‚úÖ ÏÑ∏ÏÖò Í∏∞Î∞ò Ìè¨Ïª§Ïä§(Ï£ºÏÜåÏ∞ΩÏùÄ ÍπîÎÅîÌïòÍ≤å Ïú†ÏßÄ)
    function focusFromSession() {
        const id = sessionStorage.getItem('focus_id');
        if (id) {
            focusAndOpenById(id);
            sessionStorage.removeItem('focus_id');
        }
    }

    // ‚úÖ ÌòÑÏû¨ ÏúÑÏπò Ïù¥Îèô Ìï®Ïàò ÏàòÏ†ï
    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                locPosition = new kakao.maps.LatLng(lat, lng);

                map.setCenter(locPosition);

                currentMarker.setMap(null);
                currentCircle.setMap(null);

                currentMarker = new kakao.maps.Marker({
                    position: locPosition,
                    map: map,
                    title: 'ÌòÑÏû¨ ÏúÑÏπò'
                });

                currentCircle = new kakao.maps.Circle({
                    center: locPosition,
                    radius: 200,
                    strokeWeight: 2,
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.7,
                    fillColor: '#FF0000',
                    fillOpacity: 0.1,
                    map: map
                });

                // üìå Ï£ºÏ∞®Ïû• Í±∞Î¶¨ Í∏∞Ï§Ä Ï†ïÎ†¨
                const sortedBasics = basics
                    .map(b => ({
                        ...b,
                        distance: getDistance(lat, lng, b.lat, b.lng)
                    }))
                    .sort((a, b) => a.distance - b.distance);

                // üìå Î¶¨Ïä§Ìä∏ Í∞±Ïã†
                renderParkingList(sortedBasics);

                // üìå CCTV Í∑ºÏ≤ò ÏïåÎ¶º
                let cctvNear = false;
                for (let c of cameras) {
                    const distance = getDistance(lat, lng, c.lat, c.lng);
                    if (distance <= 200) {
                        cctvNear = true;
                        break;
                    }
                }

                if (cctvNear) {
                    alert("‚ö†Ô∏è Ï£ºÏùò: ÌòÑÏû¨ ÏúÑÏπò Í∏∞Ï§Ä 200m Ïù¥ÎÇ¥Ïóê CCTVÍ∞Ä ÏûàÏäµÎãàÎã§.");
                }

            }, function (error) {
                alert("üìµ ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
                console.error(error);
            });
        } else {
            alert("üö´ ÏúÑÏπò Ï†ïÎ≥¥ ÏÇ¨Ïö©Ïù¥ Î∂àÍ∞ÄÎä•Ìïú Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
        }
    }

    const searchInput = document.getElementById('search-input');
    const autocompleteResults = document.getElementById('autocomplete-results');
    const dropdownInstance = new bootstrap.Dropdown(autocompleteResults);
    const ps = new kakao.maps.services.Places(); // Ïπ¥Ïπ¥Ïò§ Ïû•ÏÜå Í≤ÄÏÉâ
    let searchMarkers = [];

    // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
    function removeSearchMarkers() {
        searchMarkers.forEach(marker => marker.setMap(null));
        searchMarkers = [];
        infowindow.close();
    }

    // Í≤ÄÏÉâ ÏàòÌñâ ÌõÑ ÎßàÏª§ ÌëúÏãú
    function showPlaceOnMap(place) {
        removeSearchMarkers();

        const marker = new kakao.maps.Marker({
            map,
            position: new kakao.maps.LatLng(place.y, place.x),
            title: place.place_name
        });

        searchMarkers.push(marker);
        map.panTo(marker.getPosition());

        infowindow.setContent(`
    <div style="padding:5px; font-size:14px; max-width:250px;">
      <strong>${place.place_name}</strong><br>
      ${place.road_address_name || place.address_name || ''}<br>
      <a href="https://map.kakao.com/link/map/${place.id}" target="_blank" style="color:#3c80f6;">
        ÏßÄÎèÑ ÏÉÅÏÑ∏Î≥¥Í∏∞
      </a>
    </div>
  `);
        infowindow.open(map, marker);

        // üìå Í≤ÄÏÉâ ÏúÑÏπò Í∏∞Ï§Ä Ï£ºÏ∞®Ïû• Ï†ïÎ†¨
        const lat = parseFloat(place.y);
        const lng = parseFloat(place.x);

        const sortedBasics = basics
            .map(b => ({
                ...b,
                distance: getDistance(lat, lng, b.lat, b.lng)
            }))
            .sort((a, b) => a.distance - b.distance);

        renderParkingList(sortedBasics);
    }


    // ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Ïã§ÏãúÍ∞Ñ Ìò∏Ï∂ú)
    searchInput.addEventListener('input', () => {
        const keyword = searchInput.value.trim();
        autocompleteResults.innerHTML = '';

        if (!keyword) {
            dropdownInstance.hide();
            return;
        }

        console.log(keyword);

        ps.keywordSearch(keyword, (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
                data.slice(0, 5).forEach(place => { // ÏÉÅÏúÑ 5Í∞úÎßå Ï∂îÏ≤ú
                    const li = document.createElement('li');
                    li.className = 'dropdown-item';
                    li.textContent = place.place_name;
                    li.addEventListener('click', () => {
                        searchInput.value = place.place_name;
                        autocompleteResults.innerHTML = '';
                        showPlaceOnMap(place); // ÌÅ¥Î¶≠ Ïãú ÎßàÏª§ ÌëúÏãú
                    });
                    autocompleteResults.appendChild(li);
                });
            }
        }, {
            location: locPosition // Í≤ÄÏÉâ Ïãú ÌòÑÏû¨ ÏúÑÏπò Ï§ëÏã¨ÏúºÎ°ú Í≤ÄÏÉâ
        });

        dropdownInstance.show();
    });

    // ÏóîÌÑ∞ÌÇ§ Í≤ÄÏÉâ
    searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const firstItem = autocompleteResults.querySelector('li');
            if (firstItem) firstItem.click();
        }
    });

    // === (Ï∂îÍ∞Ä) ÏßÄÎèÑ ÏõÄÏßÅÏù¥Í±∞ÎÇò Ï§å Î∞îÍæ∏Î©¥ Ïù∏Ìè¨ÏúàÎèÑÏö∞ Îã´Í∏∞ ===
    function closeAllInfoWindows() {
        $(".parking-item").css("background", "white")
        infowindow.close();
        Object.values(markerMap).forEach(m => m.isOpen = false);
        Object.values(markerById).forEach(m => m.isOpen = false);
    }

    kakao.maps.event.addListener(map, 'dragstart', closeAllInfoWindows);
    kakao.maps.event.addListener(map, 'zoom_changed', closeAllInfoWindows);

    // ‚úÖ Ï¶êÍ≤®Ï∞æÍ∏∞ Î°úÎìúÍ∞Ä ÎÅùÎÇú Îí§ Ìè¨Ïª§Ïä§ Ïã§Ìñâ
    window.addEventListener('DOMContentLoaded', async () => {
        await loadFavorites();
        initFocusFromUrl();   // ÏøºÎ¶¨Î°ú Ïò® Í≤ΩÏö∞(Ìò∏Ìôò)
        focusFromSession();   // ÏÑ∏ÏÖòÏúºÎ°ú Ïò® Í≤ΩÏö∞(Ï£ºÏÜå ÍπîÎÅî)
    });
</script>

{% endblock %}
