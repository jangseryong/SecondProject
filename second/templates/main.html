{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  .full-height {
    height: calc(100vh - 56px);
  }

  .sidebar {
    width: 350px;
    background-color: #f8f9fa;
    overflow-y: auto;
  }

  .map-area {
    flex-grow: 1;
    height: 100%;
    position: relative; /* Î≤ÑÌäº ÏúÑÏπò Ï†àÎåÄ ÏßÄÏ†ïÏö© */
  }

  .list-group-item {
    margin: 0;
    padding-left: 12px;
    padding-right: 12px;
    border-left: none;
    border-right: none;
  }

  .sidebar {
    width: 350px;
    height: calc(100vh - 56px);
    display: flex;
    flex-direction: column;
  }

  .sidebar h5 {
    height: 4rem;
    line-height: 2rem;
    margin: 0;
    padding: 0 1rem;
    border-bottom: 1px solid #dee2e6;
    flex-shrink: 0;
  }

  .sidebar ul.list-group {
    flex-grow: 1;
    overflow-y: auto;
    margin: 0;
    padding: 0;
  }

  .location-button {
    position: absolute;
    bottom: 30px;
    right: 10px;
    z-index: 10;
    width: 40px;
    height: 40px;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 5px;
    cursor: pointer;
    box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .location-button img {
    width: 22px;
    height: 22px;
  }
</style>

<div class="container-fluid p-0 m-0">
  <div class="d-flex full-height">

    <!-- üÖøÔ∏è ÏôºÏ™Ω Ï£ºÏ∞®Ïû• Î™©Î°ù -->
    <div class="sidebar d-flex flex-column">
      <h5 class="p-3 m-0 border-bottom flex-shrink-0">Ï£ºÏ∞®Ïû• Î™©Î°ù</h5>
      <ul class="list-group list-group-flush flex-grow-1 overflow-auto">
        {% for b in basics %}
          <li class="list-group-item parking-item" data-name="{{ b.name }}">
            <div class="fw-bold">{{ b.name }}</div>
            Ï¥ù Íµ¨Ìöç: {{ b.total }}<br>
            Í∞ÄÏö© ÎåÄÏàò: {{ b.avblPklotCnt }}<br>
            Ï†úÍ≥µ ÏãúÍ∞Ñ: {{ b.ocrnDt }}<br>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- üó∫Ô∏è Ïò§Î•∏Ï™Ω ÏßÄÎèÑ -->
    <div class="map-area">
      <div id="map" style="width:100%; height:100%;"></div>
      <button class="location-button" onclick="moveToCurrentLocation()">
        <img src="{% static 'imgs/location_icon.png' %}" alt="ÎÇ¥ ÏúÑÏπò">
      </button>
    </div>

  </div>
</div>

<!-- üìå Kakao ÏßÄÎèÑ API -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

<script>
    const mapContainer = document.getElementById('map');
    const fixedLat = 37.6822186;
    const fixedLng = 126.769498;
    let currentMarker = null;
    let currentCircle = null;

    const locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
    const mapOption = { center: locPosition, level: 4 };
    const map = new kakao.maps.Map(mapContainer, mapOption);

    // Ï§å Î≥ÄÍ≤Ω Ïãú Î†àÎ≤® 4Î°ú Í≥†Ï†ï
    kakao.maps.event.addListener(map, 'zoom_changed', function() {
      if (map.getLevel() !== 4) {
        map.setLevel(4);
      }
    });

    // ÏßÄÎèÑ Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Î†àÎ≤® 4 Í≥†Ï†ï
    kakao.maps.event.addListener(map, 'resize', function() {
      map.setLevel(4);
    });

    const basics = JSON.parse('{{ basics_json|escapejs }}');
    const cameras = JSON.parse('{{ cctv_json|escapejs }}');
    const availability = JSON.parse('{{ availability_json|escapejs }}');

    const infowindow = new kakao.maps.InfoWindow({});
    const markerMap = {};

    // Ï£ºÏ∞®Ïû• ÎßàÏª§Ïö© Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (Ïòà: parking_marker.png)
    const parkingMarkerImage = new kakao.maps.MarkerImage(
      "{% static 'imgs/parking-area.png' %}",
      new kakao.maps.Size(35, 35), // ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ Ï°∞Ï†à
      {
        offset: new kakao.maps.Point(20, 40) // ÎßàÏª§Ïùò Í∏∞Ï§ÄÏ†êÏùÑ ÏïÑÏù¥ÏΩò ÏïÑÎûò Ï§ëÏïôÏúºÎ°ú ÏßÄÏ†ï
      }
    );

    // Ï¥àÍ∏∞ "ÎÇ¥ÏúÑÏπò" ÌëúÏãú (Í≥†Ï†ïÎêú ÏúÑÏπò)
    currentMarker = new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: 'ÎÇ¥ÏúÑÏπò'
    });

    currentCircle = new kakao.maps.Circle({
        center: locPosition,
        radius: 500,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        fillColor: '#FF0000',
        fillOpacity: 0.1,
        map: map
    });

    // Ï£ºÏ∞®Ïû• ÎßàÏª§ ÏÉùÏÑ±
    basics.forEach(b => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(b.lat, b.lng),
            title: b.name,
            map: map,
            image: parkingMarkerImage
        });
        marker.isOpen = false;
        markerMap[b.name] = marker;

        kakao.maps.event.addListener(marker, 'click', () => {
            toggleInfowindow(marker, b.name);
        });
    });

    // CCTV ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ
    const cameraMarkerImage = new kakao.maps.MarkerImage(
    "{% static 'imgs/security-camera.png' %}",  // Í≤ΩÎ°ú ÏàòÏ†ï
    new kakao.maps.Size(30, 30)  // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Ï°∞Ï†à (ÏõêÌïòÎäî ÌÅ¨Í∏∞Î°ú ÏàòÏ†ï Í∞ÄÎä•)
    );

    cameras.forEach(c => {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(c.lat, c.lng),
            title: c.name,
            map: map,
            image: cameraMarkerImage
        });

        marker.isOpen = false;

        kakao.maps.event.addListener(marker, 'click', () => {
            if (marker.isOpen) {
                infowindow.close();
                marker.isOpen = false;
            } else {
                infowindow.close();
                infowindow.setContent(`
                    <div class="card" style="width: 18rem; margin:0;">
                        <div class="card-body">
                            <h5 class="card-title">${c.name}</h5>
                        </div>
                    </div>
                `);
                infowindow.open(map, marker);
                marker.isOpen = true;
            }
        });
    });

    availability.forEach(a => {
        const b = basics.find(b => b.name === a.name);
        if (!b) return;

        const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(b.lat, b.lng),
        title: b.name,
        map: map,
        image: parkingMarkerImage
    });


        marker.isOpen = false;

        kakao.maps.event.addListener(marker, 'click', () => {
            toggleInfowindow(marker, a.name);
        });

        markerMap[a.name] = marker;
    });

    function toggleInfowindow(marker, name) {
        const a = availability.find(av => av.name === name);
        const b = basics.find(b => b.name === name);

        if (marker.isOpen) {
            infowindow.close();
            marker.isOpen = false;
        } else {
            infowindow.close();
            infowindow.setContent(`
                <div class="card" style="width: 18rem; margin:0;">
                    <div class="card-body">
                        <h5 class="card-title">${name}</h5>
                        <p class="card-text">
                            Ï¥ù Íµ¨Ìöç: ${a ? a.total : b.total}<br>
                            Í∞ÄÏö© Íµ¨Ìöç: ${a ? a.available : 'N/A'}<br>
                            Ï†úÍ≥µ ÏãúÍ∞Ñ: ${a ? a.time : '-'}
                        </p>
                    </div>
                </div>
            `);
            infowindow.open(map, marker);
            marker.isOpen = true;
        }
    }

    document.querySelectorAll('.parking-item').forEach(item => {
        item.addEventListener('click', () => {
            const name = item.getAttribute('data-name');
            const marker = markerMap[name];
            if (marker) {
                map.panTo(marker.getPosition());
                toggleInfowindow(marker, name);
            }
        });
    });

    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // ‚úÖ ÌòÑÏúÑÏπòÎ°ú Ïù¥Îèô Ìï®Ïàò
    function moveToCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const newPosition = new kakao.maps.LatLng(lat, lng);

          map.setCenter(newPosition);

          // Í∏∞Ï°¥ ÎßàÏª§/Ïõê Ï†úÍ±∞
          if (currentMarker) currentMarker.setMap(null);
          if (currentCircle) currentCircle.setMap(null);

          // ÏÉà ÎßàÏª§/Ïõê Ï∂îÍ∞Ä
          currentMarker = new kakao.maps.Marker({
            position: newPosition,
            map: map,
            title: 'ÌòÑÏû¨ ÏúÑÏπò'
          });

          currentCircle = new kakao.maps.Circle({
            center: newPosition,
            radius: 500,
            strokeWeight: 2,
            strokeColor: '#FF0000',
            strokeOpacity: 0.7,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map
          });

          // CCTV Í±∞Î¶¨ ÌôïÏù∏
          let cctvNear = false;
          for (let c of cameras) {
            const distance = getDistance(lat, lng, c.lat, c.lng);
            if (distance <= 200) {
              cctvNear = true;
              break;
            }
          }

          if (cctvNear) {
            alert("‚ö†Ô∏è Ï£ºÏùò: ÌòÑÏû¨ ÏúÑÏπò Í∏∞Ï§Ä 200m Ïù¥ÎÇ¥Ïóê CCTVÍ∞Ä ÏûàÏäµÎãàÎã§.");
          }

        }, function(error) {
          alert("üìµ ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
          console.error(error);
        });
      } else {
        alert("üö´ ÏúÑÏπò Ï†ïÎ≥¥ ÏÇ¨Ïö©Ïù¥ Î∂àÍ∞ÄÎä•Ìïú Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
      }
    }
</script>

{% endblock %}
