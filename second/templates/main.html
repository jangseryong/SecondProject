{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  .full-height {
    height: calc(100vh - 56px);
  }

  .sidebar {
    width: 350px;
    background-color: #f8f9fa;
    overflow-y: auto;
  }

  .map-area {
    flex-grow: 1;
    height: 100%;
    position: relative;
  }

  .list-group-item {
    margin: 0;
    padding-left: 12px;
    padding-right: 12px;
    border-left: none;
    border-right: none;
  }

  .sidebar {
    width: 350px;
    height: calc(100vh - 56px);
    display: flex;
    flex-direction: column;
  }

  .sidebar h5 {
    height: 4rem;
    line-height: 2rem;
    margin: 0;
    padding: 0 1rem;
    border-bottom: 1px solid #dee2e6;
    flex-shrink: 0;
  }

  .sidebar ul.list-group {
    flex-grow: 1;
    overflow-y: auto;
    margin: 0;
    padding: 0;
  }

  .location-button {
    position: absolute;
    bottom: 30px;
    right: 10px;
    z-index: 10;
    width: 40px;
    height: 40px;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 5px;
    cursor: pointer;
    box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .location-button img {
    width: 22px;
    height: 22px;
  }
</style>

<div class="container-fluid p-0 m-0">
  <div class="d-flex full-height">

    <!-- üÖøÔ∏è ÏôºÏ™Ω Ï£ºÏ∞®Ïû• Î™©Î°ù -->
    <div class="sidebar d-flex flex-column">
      <h5 class="p-3 m-0 border-bottom flex-shrink-0">Ï£ºÏ∞®Ïû• Î™©Î°ù</h5>
      <ul class="list-group list-group-flush flex-grow-1 overflow-auto">
        {% for b in basics %}
          <li class="list-group-item parking-item" data-name="{{ b.name }}">
            <div class="fw-bold">{{ b.name }}</div>
            Ï¥ù Íµ¨Ìöç: {{ b.total }}<br>
            Í∞ÄÏö© ÎåÄÏàò: {{ b.avblPklotCnt }}<br>
            Ï†úÍ≥µ ÏãúÍ∞Ñ: {{ b.ocrnDt }}<br>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- üó∫Ô∏è Ïò§Î•∏Ï™Ω ÏßÄÎèÑ -->
    <div class="map-area">
      <div id="map" style="width:100%; height:100%;"></div>
      <button class="location-button" onclick="moveToCurrentLocation()">
        <img src="{% static 'imgs/location_icon.png' %}" alt="ÎÇ¥ ÏúÑÏπò">
      </button>
    </div>

  </div>
</div>

<!-- üìå Kakao ÏßÄÎèÑ API -->
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=863559e6bebce003983f160e07c1ac27&libraries=services"></script>

<script>
  // ================== Î°úÍ∑∏Ïù∏ Ïó¨Î∂Ä ÌîåÎûòÍ∑∏ ==================
  const IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};

  // ================== Ï¶êÍ≤®Ï∞æÍ∏∞ Ï†ÑÏó≠ Í¥ÄÎ¶¨ ==================
  let FAVORITE_SET = new Set();
  let CSRF_TOKEN = null;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  async function loadFavorites() {
    if (!IS_AUTHENTICATED) {
      FAVORITE_SET = new Set();
      return;
    }
    try {
      const res = await fetch('/favorites/ids/', { credentials: 'same-origin' });
      if (!res.ok) return;
      const data = await res.json();
      if (data.ok) {
        // üîß IDÎ•º Î¨∏ÏûêÏó¥Î°ú ÌÜµÏùº
        FAVORITE_SET = new Set((data.ids || []).map(String));
        CSRF_TOKEN = data.csrfToken || getCookie('csrftoken');
      }
    } catch (e) {
      console.error(e);
    }
  }

  function setStarIcon(btnEl) {
    const pk = btnEl?.dataset?.pk;
    if (!pk) return;
    const icon = btnEl.querySelector('.star-icon');
    if (!icon) return;
    if (!IS_AUTHENTICATED) {
      icon.textContent = '‚òÜ';
      return;
    }
    // üîß Î¨∏ÏûêÏó¥ ÎπÑÍµê
    icon.textContent = FAVORITE_SET.has(String(pk)) ? '‚≠ê' : '‚òÜ';
  }

  // ÌÅ¥Î¶≠ Ïãú ÌÜ†Í∏Ä (ÎπÑÎ°úÍ∑∏Ïù∏: ÏñºÎüøÎßå)
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.favorite-btn');
    if (!btn) return;

    if (!IS_AUTHENTICATED) {
      alert('Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    const pk = btn.dataset.pk;
    const icon = btn.querySelector('.star-icon');

    try {
      const res = await fetch(`/favorites/${pk}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': CSRF_TOKEN || getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
      });

      if (res.status === 403) {
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        return;
      }
      const data = await res.json();
      if (!data.ok) {
        alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        return;
      }

      if (data.status === 'added') {
        FAVORITE_SET.add(String(pk));     // üîß Î¨∏ÏûêÏó¥Î°ú
        if (icon) icon.textContent = '‚≠ê';
      } else {
        FAVORITE_SET.delete(String(pk));  // üîß Î¨∏ÏûêÏó¥Î°ú
        if (icon) icon.textContent = '‚òÜ';
      }
    } catch (err) {
      console.error(err);
      alert('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  });

  // ================== ÏßÄÎèÑ Î°úÏßÅ ==================
  const mapContainer = document.getElementById('map');
  const fixedLat = 37.6822186;
  const fixedLng = 126.769498;
  let currentMarker = null;
  let currentCircle = null;

  const locPosition = new kakao.maps.LatLng(fixedLat, fixedLng);
  const mapOption = { center: locPosition, level: 4 };
  const map = new kakao.maps.Map(mapContainer, mapOption);

  map.setZoomable(false);

  const basics = JSON.parse('{{ basics_json|escapejs }}');
  const cameras = JSON.parse('{{ cctv_json|escapejs }}');
  const availability = JSON.parse('{{ availability_json|escapejs }}');

  const infowindow = new kakao.maps.InfoWindow({});
  const markerMap = {};   // name -> marker
  const markerById = {};  // id   -> marker
  const basicsById = {};  // id   -> basic info

  const parkingMarkerImage = new kakao.maps.MarkerImage(
    "{% static 'imgs/parking-area.png' %}",
    new kakao.maps.Size(35, 35),
    { offset: new kakao.maps.Point(20, 40) }
  );

  currentMarker = new kakao.maps.Marker({
      position: locPosition,
      map: map,
      title: 'ÎÇ¥ÏúÑÏπò'
  });

  currentCircle = new kakao.maps.Circle({
      center: locPosition,
      radius: 500,
      strokeWeight: 2,
      strokeColor: '#FF0000',
      strokeOpacity: 0.7,
      fillColor: '#FF0000',
      fillOpacity: 0.1,
      map: map
  });

  basics.forEach(b => {
    const idStr = String(b.id);            // üîß Î¨∏ÏûêÏó¥ ÌÇ§
    basicsById[idStr] = b;
    const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(b.lat, b.lng),
        title: b.name,
        map: map,
        image: parkingMarkerImage
    });
    marker.isOpen = false;
    markerMap[b.name] = marker;
    markerById[idStr] = marker;            // üîß Î¨∏ÏûêÏó¥ ÌÇ§

    kakao.maps.event.addListener(marker, 'click', () => {
        toggleInfowindow(marker, b.name);
    });
  });

  const cameraMarkerImage = new kakao.maps.MarkerImage(
    "{% static 'imgs/security-camera.png' %}",
    new kakao.maps.Size(30, 30)
  );

  cameras.forEach(c => {
      const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(c.lat, c.lng),
          title: c.name,
          map: map,
          image: cameraMarkerImage
      });

      marker.isOpen = false;

      kakao.maps.event.addListener(marker, 'click', () => {
          if (marker.isOpen) {
              infowindow.close();
              marker.isOpen = false;
          } else {
              infowindow.close();
              infowindow.setContent(`
                  <div class="card" style="width: 18rem; margin:0;">
                      <div class="card-body">
                          <h5 class="card-title">${c.name}</h5>
                      </div>
                  </div>
              `);
              infowindow.open(map, marker);
              marker.isOpen = true;
          }
      });
  });

  availability.forEach(a => {
      const b = basics.find(b => b.name === a.name);
      if (!b) return;

      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(b.lat, b.lng),
        title: b.name,
        map: map,
        image: parkingMarkerImage
      });

      marker.isOpen = false;
      kakao.maps.event.addListener(marker, 'click', () => {
          toggleInfowindow(marker, a.name);
      });

      markerMap[a.name] = marker;
  });

  function toggleInfowindow(marker, name) {
    const b = basics.find(b => b.name === name);
    if (!b) return;

    if (marker.isOpen) {
        infowindow.close();
        marker.isOpen = false;
    } else {
        infowindow.close();

        // ‚úÖ Ìï≠ÏÉÅ ÏµúÏã† ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉÅÌÉú(FAVORITE_SET) Í∏∞Ï§ÄÏúºÎ°ú Î≥Ñ ÌëúÏãú
        const starChar = IS_AUTHENTICATED
          ? (FAVORITE_SET.has(String(b.id)) ? '‚≠ê' : '‚òÜ')
          : '‚òÜ';

        infowindow.setContent(`
            <div class="card shadow-sm" style="width: 300px; font-size: 14px; overflow-x: hidden;">
                <div class="card-header bg-primary text-white fw-bold">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>${b.name}</span>
                      <button class="btn btn-sm btn-light favorite-btn" data-pk="${b.id}" title="Ï¶êÍ≤®Ï∞æÍ∏∞" style="line-height:1">
                        <span class="star-icon">${starChar}</span>
                      </button>
                  </div>
                </div>

                <div class="card-body p-2">
                    <div class="row gx-0 text-center mb-2">
                        <div class="col-6 border-end">
                            <div class="fw-bold">Ï¥ù Î©¥Ïàò</div>
                            <div>${b.total}</div>
                        </div>
                        <div class="col-6 bg-success text-white">
                            <div class="fw-bold">Í∞ÄÏö© Î©¥Ïàò</div>
                            <div>${b.avblPklotCnt}</div>
                        </div>
                    </div>

                    <hr>

                    <table class="table table-sm mb-0">
                        <tbody>
                            <tr>
                                <th scope="row">Ï£ºÏÜå</th>
                                <td>${b.address || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</td>
                            </tr>
                            <tr>
                                <th scope="row">Ïö¥ÏòÅÏãúÍ∞Ñ</th>
                                <td>
                                    ÌèâÏùº: ${b.weekdayTime || '-'}<br>
                                    ÌÜ†ÏöîÏùº: ${b.saturdayTime || '-'}<br>
                                    Ìú¥Ïùº: ${b.holidayTime || '-'}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Ï£ºÏ∞®ÏöîÍ∏à</th>
                                <td>
                                    Í∏∞Î≥∏: ${b.basicRate || '-'}<br>
                                    Ï∂îÍ∞Ä: ${b.addRate || '-'}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `);

        infowindow.open(map, marker);
        marker.isOpen = true;

        kakao.maps.event.addListener(infowindow, 'domready', function() {
          const btn = document.querySelector('.favorite-btn[data-pk="' + b.id + '"]');
          if (btn) setStarIcon(btn);
        });
    }
  }

  document.querySelectorAll('.parking-item').forEach(item => {
      item.addEventListener('click', () => {
          const name = item.getAttribute('data-name');
          const marker = markerMap[name];
          if (marker) {
              map.panTo(marker.getPosition());
              toggleInfowindow(marker, name);
          }
      });
  });

  // ==== URL ÌååÎùºÎØ∏ÌÑ∞ Ìè¨Ïª§Ïä§ (Ï¶êÍ≤®Ï∞æÍ∏∞ Î°úÎìú ÌõÑ Ïã§Ìñâ) ====
  function focusAndOpenById(id) {
    const key = String(id);           // üîß Î¨∏ÏûêÏó¥ ÌÇ§
    const b = basicsById[key], m = markerById[key];
    if (!b || !m) return false;
    map.panTo(m.getPosition());
    toggleInfowindow(m, b.name);
    return true;
  }
  function focusAndOpenByName(name) {
    const m = markerMap[name];
    if (!m) return false;
    map.panTo(m.getPosition());
    toggleInfowindow(m, name);
    return true;
  }
  function initFocusFromUrl() {
    const params = new URLSearchParams(location.search);
    const focusId = params.get('focus_id');
    const focusName = params.get('focus');
    if (focusId) {
      if (!focusAndOpenById(focusId) && focusName) focusAndOpenByName(focusName);
    } else if (focusName) {
      focusAndOpenByName(focusName);
    }
  }

  function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
  }

  function moveToCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const newPosition = new kakao.maps.LatLng(lat, lng);

        map.setCenter(newPosition);

        if (currentMarker) currentMarker.setMap(null);
        if (currentCircle) currentCircle.setMap(null);

        currentMarker = new kakao.maps.Marker({
          position: newPosition,
          map: map,
          title: 'ÌòÑÏû¨ ÏúÑÏπò'
        });

        currentCircle = new kakao.maps.Circle({
          center: newPosition,
          radius: 500,
          strokeWeight: 2,
          strokeColor: '#FF0000',
          strokeOpacity: 0.7,
          fillColor: '#FF0000',
          fillOpacity: 0.1,
          map: map
        });

        let cctvNear = false;
        for (let c of cameras) {
          const distance = getDistance(lat, lng, c.lat, c.lng);
          if (distance <= 200) {
            cctvNear = true;
            break;
          }
        }

        if (cctvNear) {
          alert("‚ö†Ô∏è Ï£ºÏùò: ÌòÑÏû¨ ÏúÑÏπò Í∏∞Ï§Ä 200m Ïù¥ÎÇ¥Ïóê CCTVÍ∞Ä ÏûàÏäµÎãàÎã§.");
        }

      }, function(error) {
        alert("üìµ ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
        console.error(error);
      });
    } else {
      alert("üö´ ÏúÑÏπò Ï†ïÎ≥¥ ÏÇ¨Ïö©Ïù¥ Î∂àÍ∞ÄÎä•Ìïú Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
    }
  }

  // ‚úÖ Ï¶êÍ≤®Ï∞æÍ∏∞ Î°úÎìúÍ∞Ä ÎÅùÎÇú Îí§ Ìè¨Ïª§Ïä§ Ïã§Ìñâ
  window.addEventListener('DOMContentLoaded', async () => {
    await loadFavorites();
    initFocusFromUrl();
  });
</script>

{% endblock %}
